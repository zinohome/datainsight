# 部件寿命图表（l_h_health_bar）数据链路和配置说明

## 📊 图表概述

**图表ID**: `l_h_health_bar`  
**图表类型**: `fact.AntdBar` (堆叠柱状图)  
**位置**: `views/core_pages/dashboard_line_charts.py` (第708行)  
**用途**: 展示选定车号的所有车厢部件的耗用率，以堆叠柱状图形式呈现

---

## 🔄 数据链路流程图

```
数据库表 c_chart_health_equipment
    ↓
动态ORM模型 (DynamicChartHealthEquipment)
    ↓
get_health_data() 函数
    │
    ├─→ 查询所有健康数据 (按耗用率降序)
    │   ├─ 字段: 车号, 车厢号/车厢, 部件, 耗用率
    │   └─ 格式化为 formatted_health 和 new_formatted_health
    │
    └─→ 构建 bar_data (图表数据)
        ├─ 从 BaseConfig.health_bar_data_rnd 轮播选择车号
        ├─ 筛选该车号的所有车厢数据
        └─ 转换为图表数据格式:
            {
                'carriage': "车号-车厢号",  # 例如: "1633-1"
                'ratio': 耗用率 * 100,     # 百分比 (0-100)
                'param': 部件名称           # 去除了 "-" 符号
            }
    ↓
update_both_tables() 回调函数
    │
    ├─ 调用 get_health_data()
    └─ 返回 bar_data 给图表组件
    ↓
fact.AntdBar 组件渲染
```

---

## 🗄️ 数据库层

### 表名
- `c_chart_health_equipment` (schema: `public`)

### 动态模型适配
根据 `BaseConfig.use_carriage_field` 配置：

**当 `use_carriage_field = True` 时**：
- 使用 `车厢` 字段 (CharField)
- 模型字段: `车厢`, `车号`, `部件`, `耗用率`, `额定寿命`, `已耗`

**当 `use_carriage_field = False` 时** (默认):
- 使用 `车厢号` 字段 (IntegerField)
- 模型字段: `车号`, `车厢号`, `部件`, `耗用率`, `额定寿命`, `已耗`

### 数据查询逻辑
```python
DynamicHealthModel.select().order_by(DynamicHealthModel.耗用率.desc())
```
- 查询所有健康设备数据
- 按耗用率降序排列（耗用率高的在前）

---

## 📡 数据获取层 (`callbacks/core_pages_c/dashboard_line_c.py`)

### 函数: `get_health_data()`

**位置**: 第141-217行

#### 1. 数据查询
```python
DynamicHealthModel = get_dynamic_health_model()
health_query = DynamicHealthModel.select().order_by(
    DynamicHealthModel.耗用率.desc()
)
```

#### 2. 数据格式化
根据配置生成两种格式的数据：

**formatted_health**: 完整数据（用于其他用途）
```python
{
    '车号': str,
    '车厢号': str/int,  # 根据配置决定
    '部件': str,
    '耗用率': float,    # 0-1之间的小数
    '操作': {...}
}
```

**new_formatted_health**: 表格显示数据（用于 l_h_health_table）
```python
{
    '车厢': str,         # 车厢号/车厢
    '部件': str,
    '耗用率': float,
    '操作': {...}
}
```

#### 3. 图表数据构建 (`bar_data`)

**轮播逻辑**:
```python
# 从配置中轮播选择车号
health_bar_data = BaseConfig.health_bar_data_rnd
# 例如: ['1633', '1634', '1635', '1636', '1637', '1638', '1639']
select_train = health_bar_data[get_health_data.select_index % len(health_bar_data)]
get_health_data.select_index += 1  # 每次调用递增
```

**数据筛选和转换**:
```python
for item in formatted_health:
    if item['车号'] == select_train:  # 筛选指定车号
        bar_data.append({
            'carriage': f"{item['车号']}-{item['车厢号']}",  # Y轴: "车号-车厢号"
            'ratio': round(item['耗用率'] * 100, 2),        # X轴: 百分比 (0-100)
            'param': item['部件'].replace('-', '')           # 系列: 部件名称
        })
```

**返回**: `(new_formatted_health, bar_data)`

---

## 🎯 回调层 (`callbacks/core_pages_c/dashboard_line_c.py`)

### 回调函数: `update_both_tables()`

**位置**: 第220-509行  
**触发**: `Input('l-update-data-interval', 'n_intervals')`  
**更新间隔**: `BaseConfig.line_update_data_interval` (默认15000ms = 15秒)

**输出**:
```python
Output('l_h_health_bar', 'data')  # 第227行
```

**调用链**:
```python
formatted_health, bar_data = get_health_data()
# bar_data 直接传递给图表组件
```

---

## 🎨 图表配置层 (`views/core_pages/dashboard_line_charts.py`)

### 组件: `fact.AntdBar` (第708-733行)

#### 当前配置

**基础属性**:
```python
id='l_h_health_bar'
data=初始数据  # 会被回调更新，初始数据仅占位
```

**数据映射**:
- `xField='ratio'`: X轴显示耗用率（百分比 0-100）
- `yField='carriage'`: Y轴显示车厢（格式: "车号-车厢号"）
- `seriesField='param'`: 系列字段（部件名称），用于堆叠

**堆叠配置**:
- `isStack=True`: 启用堆叠模式
- `isPercent=False`: 不使用百分比堆叠（使用绝对值）

**标签配置**:
```python
label={'formatter': {'func': '(item) => item.ratio.toFixed(2)'}}
```
- 显示数值，保留2位小数

**样式配置**:
```python
style={
    'height': '250px',
    'width': '100%',
    'border': 'none',
    'border-collapse': 'collapse',
    'border-spacing': '0',
    'backgroundColor': 'transparent'
}
```

---

## ⚙️ 配置参数

### `BaseConfig.health_bar_data_rnd`
**位置**: `configs/base_config.py` 第75行

**当前值**:
```python
health_bar_data_rnd = ['1633', '1634', '1635', '1636', '1637', '1638', '1639']
```

**作用**: 
- 图表轮播显示的车号列表
- 每次更新时按顺序切换到下一个车号
- 如果没有数据，会跳过（图表为空）

### `BaseConfig.use_carriage_field`
**作用**: 控制使用 `车厢` 还是 `车厢号` 字段

### `BaseConfig.line_update_data_interval`
**当前值**: 15000ms (15秒)  
**作用**: 图表数据更新间隔

---

## 📋 数据格式示例

### 图表接收的数据格式 (`bar_data`)
```python
[
    {
        'carriage': '1633-1',    # Y轴标签
        'ratio': 45.67,          # X轴值（百分比）
        'param': '压缩机'         # 系列（用于堆叠）
    },
    {
        'carriage': '1633-1',
        'ratio': 23.45,
        'param': '冷凝器'
    },
    {
        'carriage': '1633-2',
        'ratio': 56.78,
        'param': '压缩机'
    },
    # ... 更多数据
]
```

### 图表显示逻辑
- **Y轴**: 每个车厢一行（"车号-车厢号"）
- **X轴**: 耗用率百分比（0-100）
- **堆叠**: 同一车厢的不同部件堆叠在一起
- **颜色**: 每个部件（param）使用不同颜色

---

## 🔍 问题诊断

### 图表不显示的常见原因

1. **数据为空**
   - 检查数据库中 `c_chart_health_equipment` 表是否有数据
   - 检查 `BaseConfig.health_bar_data_rnd` 中的车号是否存在对应数据

2. **轮播逻辑问题**
   - `get_health_data.select_index` 可能超出范围
   - 选中的车号没有对应的健康数据

3. **字段映射错误**
   - `BaseConfig.use_carriage_field` 配置与实际数据库不匹配
   - 车厢字段名错误

4. **图表配置问题**
   - 容器高度不足（已修复为300px）
   - 图表高度设置（已修复为250px）

5. **回调未触发**
   - 检查 `l-update-data-interval` 定时器是否正常
   - 检查回调函数是否正确注册

---

## 💡 优化建议

### 1. 图表配置优化
- [ ] 添加图例 (legend) 显示部件名称
- [ ] 添加坐标轴标签和单位
- [ ] 优化颜色方案（区分不同类型的部件）
- [ ] 添加数据提示框（tooltip）

### 2. 数据筛选优化
- [ ] 支持手动选择要显示的车号（替代自动轮播）
- [ ] 添加耗用率阈值筛选（只显示超过阈值的部件）
- [ ] 支持按部件类型分组显示

### 3. 交互优化
- [ ] 添加图表点击事件（跳转到详情页）
- [ ] 支持图表缩放和数据钻取
- [ ] 添加数据刷新按钮

---

## 🔗 相关文件

- **视图**: `views/core_pages/dashboard_line_charts.py`
- **回调**: `callbacks/core_pages_c/dashboard_line_c.py`
- **模型**: `utils/dynamic_models.py`
- **配置**: `configs/base_config.py`
- **数据库表**: `c_chart_health_equipment`

---

**文档生成时间**: 2024-12-19  
**最后更新**: 根据代码版本自动生成

